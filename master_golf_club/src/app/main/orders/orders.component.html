<div class="orders-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="container">
      <div class="row">
        <div class="col-12">
          <h1>My Bookings</h1>
          <p>Manage your tee time bookings and join requests</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container">
    <div class="row">
      <div class="col-12">
        <!-- Booking Statistics Dashboard -->
        <div class="stats-dashboard">
          <div class="row">
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
              <div class="stat-card">
                <div class="stat-icon">
                  <fa-icon [icon]="calendarIcon"></fa-icon>
                </div>
                <div class="stat-content">
                  <h3>{{getBookingStatistics().totalBookings}}</h3>
                  <p>Total Bookings</p>
                </div>
              </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
              <div class="stat-card confirmed">
                <div class="stat-icon">
                  <fa-icon [icon]="checkCircleIcon"></fa-icon>
                </div>
                <div class="stat-content">
                  <h3>{{getBookingStatistics().confirmed}}</h3>
                  <p>Confirmed</p>
                </div>
              </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
              <div class="stat-card pending">
                <div class="stat-icon">
                  <fa-icon [icon]="exclamationTriangleIcon"></fa-icon>
                </div>
                <div class="stat-content">
                  <h3>{{getBookingStatistics().pendingRequests}}</h3>
                  <p>Pending Requests</p>
                </div>
              </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
              <div class="stat-card approved">
                <div class="stat-icon">
                  <fa-icon [icon]="usersIcon"></fa-icon>
                </div>
                <div class="stat-content">
                  <h3>{{getBookingStatistics().requestsAccepted}}</h3>
                  <p>Requests Accepted</p>
                </div>
              </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
              <div class="stat-card actions">
                <div class="stat-icon">
                  <fa-icon [icon]="infoIcon"></fa-icon>
                </div>
                <div class="stat-content">
                  <h3>{{getBookingStatistics().acceptRejectActions}}</h3>
                  <p>Accept/Reject Actions</p>
                </div>
              </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
              <div class="stat-card cancelled">
                <div class="stat-icon">
                  <fa-icon [icon]="timesIcon"></fa-icon>
                </div>
                <div class="stat-content">
                  <h3>{{getBookingStatistics().cancelled}}</h3>
                  <p>Cancelled</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Filter Controls -->
        <div class="filter-controls">
          <div class="row">
            <div class="col-md-6">
              <div class="filter-group">
                <label for="statusFilter">Filter by Status:</label>
                <select 
                  id="statusFilter" 
                  class="form-control" 
                  [(ngModel)]="selectedStatusFilter"
                  (change)="onStatusFilterChange($event.target.value)">
                  <option 
                    *ngFor="let filter of statusFilters" 
                    [value]="filter.value">
                    {{filter.label}} ({{filter.count}})
                  </option>
                </select>
              </div>
            </div>
            <div class="col-md-6 text-end">
              <button class="btn btn-outline-primary" (click)="refreshData()">
                <fa-icon [icon]="spinnerIcon" *ngIf="isLoading"></fa-icon>
                Refresh
              </button>
            </div>
          </div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" *ngIf="isEmptyState() && !isLoading">
          <div class="text-center py-5">
            <div class="empty-icon mb-3">
              <fa-icon [icon]="calendarIcon" size="3x"></fa-icon>
            </div>
            <h3>No Bookings Found</h3>
            <p class="text-muted">You haven't made any bookings yet.</p>
            <button class="btn btn-primary" (click)="navigateToTeeBooking()">
              Book Tee Time
            </button>
          </div>
        </div>

        <!-- Bookings Table -->
        <div class="bookings-table" *ngIf="!isEmptyState() && !isLoading">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>BOOKING ID</th>
                  <th>BOOKED DATE</th>
                  <th>COURSE NAME</th>
                  <th>TEE</th>
                  <th>SLOT DATE</th>
                  <th>SLOT TIME</th>
                  <th>PARTICIPANTS</th>
                  <th>STATUS</th>
                  <th>ACTION</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let booking of getFilteredBookings()" [class]="getStatusClass(booking.status)">
                  <td>
                    <strong>{{booking.booking_id}}</strong>
                    <span *ngIf="booking.hasMultipleSlots" class="badge badge-info ms-1">
                      Slot {{booking.slotNumber}}
                    </span>
                  </td>
                  <td>{{booking.formattedDate}}</td>
                  <td>{{booking.courseName}}</td>
                  <td>{{booking.teeInfo}}</td>
                  <td>{{formatDate(booking.slot_date)}}</td>
                  <td>{{booking.booking_time}}</td>
                  <td>
                    <span [class]="getStatusBadgeClass(booking)">
                      {{getParticipantDisplayText(booking)}}
                    </span>
                  </td>
                  <td>
                    <span [class]="getStatusBadgeClass(booking)">
                      {{getStatusDisplayText(booking)}}
                    </span>
                  </td>
                  <td>
                    <button 
                      class="btn btn-sm"
                      [class]="getActionButton(booking).color === 'green' ? 'btn-success' : 
                               getActionButton(booking).color === 'purple' ? 'btn-warning' : 
                               getActionButton(booking).color === 'blue' ? 'btn-primary' : 'btn-secondary'"
                      (click)="handleActionButtonClick(booking)"
                      [disabled]="!getActionButton(booking).enabled">
                      <fa-icon [icon]="getActionButton(booking).action === 'addParticipants' ? plusIcon : 
                                     getActionButton(booking).action === 'reviewRequest' ? infoIcon : eyeIcon"
                               class="me-1"></fa-icon>
                      {{getActionButton(booking).text}}
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Loading State -->
        <div class="loading-state text-center py-5" *ngIf="isLoading">
          <fa-icon [icon]="spinnerIcon" size="2x" class="fa-spin"></fa-icon>
          <p class="mt-3">Loading bookings...</p>
        </div>

        <!-- Error State -->
        <div class="error-state text-center py-5" *ngIf="errorMessage && !isLoading">
          <fa-icon [icon]="exclamationTriangleIcon" size="2x" class="text-danger"></fa-icon>
          <p class="mt-3 text-danger">{{errorMessage}}</p>
          <button class="btn btn-outline-primary" (click)="refreshData()">Try Again</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Participants Modal -->
<div class="modal fade" [class.show]="showParticipantModal" [style.display]="showParticipantModal ? 'block' : 'none'">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add More Participants</h5>
        <button type="button" class="btn-close" (click)="closeParticipantModal()"></button>
      </div>
      <div class="modal-body" *ngIf="selectedBookingForParticipants">
        <div class="booking-details mb-3">
          <p><strong>Course:</strong> {{selectedBookingForParticipants.courseName}}</p>
          <p><strong>Tee:</strong> {{selectedBookingForParticipants.teeInfo}}</p>
          <p><strong>Date:</strong> {{formatDate(selectedBookingForParticipants.slot_date)}}</p>
          <p><strong>Time:</strong> {{selectedBookingForParticipants.booking_time}}</p>
          <p><strong>Current:</strong> {{selectedBookingForParticipants.participants}} participants</p>
          <p><strong>Available:</strong> {{4 - selectedBookingForParticipants.participants}} spots remaining</p>
        </div>
        
        <div class="form-group">
          <label for="participants">Add Participants:</label>
          <div class="input-group">
            <button type="button" class="btn btn-outline-secondary" (click)="decrementParticipants()">-</button>
            <input type="number" class="form-control text-center" 
                   [(ngModel)]="requestedParticipants" 
                   [min]="1" 
                   [max]="4 - selectedBookingForParticipants.participants"
                   readonly>
            <button type="button" class="btn btn-outline-secondary" (click)="incrementParticipants()">+</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeParticipantModal()">Cancel</button>
        <button type="button" class="btn btn-success" (click)="confirmAddParticipants()">
          <fa-icon [icon]="plusIcon" class="me-1"></fa-icon>
          Add Participants
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Review Join Request Modal -->
<div class="modal fade" [class.show]="showReviewRequestModal" [style.display]="showReviewRequestModal ? 'block' : 'none'">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Review Join Request</h5>
        <button type="button" class="btn-close" (click)="closeReviewRequestModal()"></button>
      </div>
      <div class="modal-body" *ngIf="selectedJoinRequest">
        <div class="requester-info mb-3">
          <h6>Requester Information:</h6>
          <p><strong>Name:</strong> {{selectedJoinRequest.requesterName}}</p>
          <p><strong>Email:</strong> {{selectedJoinRequest.requesterEmail}}</p>
          <p><strong>Request Date:</strong> {{selectedJoinRequest.formattedDate}}</p>
        </div>
        
        <div class="booking-details mb-3">
          <h6>Booking Details:</h6>
          <p><strong>Course:</strong> {{selectedJoinRequest.courseName}}</p>
          <p><strong>Tee:</strong> {{selectedJoinRequest.teeInfo}}</p>
          <p><strong>Date:</strong> {{formatDate(selectedJoinRequest.slot_date)}}</p>
          <p><strong>Time:</strong> {{selectedJoinRequest.booking_time}}</p>
          <p><strong>Current Participants:</strong> {{selectedJoinRequest.participants}} (You)</p>
          <p><strong>Requested Participants:</strong> {{selectedJoinRequest.participants}}</p>
          <p><strong>Total if Approved:</strong> {{selectedJoinRequest.participants + selectedJoinRequest.participants}} participants</p>
        </div>
        
        <div class="form-group">
          <label>Action:</label>
          <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="reviewAction" id="approve" 
                   [(ngModel)]="reviewAction" value="approve" checked>
            <label class="btn btn-outline-success" for="approve">
              <fa-icon [icon]="checkIcon" class="me-1"></fa-icon>
              Approve
            </label>
            
            <input type="radio" class="btn-check" name="reviewAction" id="reject" 
                   [(ngModel)]="reviewAction" value="reject">
            <label class="btn btn-outline-danger" for="reject">
              <fa-icon [icon]="banIcon" class="me-1"></fa-icon>
              Reject
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeReviewRequestModal()">Cancel</button>
        <button type="button" 
                [class]="reviewAction === 'approve' ? 'btn-success' : 'btn-danger'"
                (click)="confirmReviewRequest()">
          <fa-icon [icon]="reviewAction === 'approve' ? checkIcon : banIcon" class="me-1"></fa-icon>
          {{reviewAction === 'approve' ? 'Approve' : 'Reject'}}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Booking Details Modal -->
<div class="modal fade" [class.show]="showBookingDetails" [style.display]="showBookingDetails ? 'block' : 'none'">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Booking Details</h5>
        <button type="button" class="btn-close" (click)="closeBookingDetails()"></button>
      </div>
      <div class="modal-body" *ngIf="selectedBooking">
        <div class="booking-info">
          <p><strong>Booking ID:</strong> {{selectedBooking.booking_id}}</p>
          <p><strong>Status:</strong> 
            <span [class]="getStatusBadgeClass(selectedBooking)">
              {{getStatusDisplayText(selectedBooking)}}
            </span>
          </p>
          <p><strong>Booked Date:</strong> {{selectedBooking.formattedDate}}</p>
          <p><strong>Course:</strong> {{selectedBooking.courseName}}</p>
          <p><strong>Tee:</strong> {{selectedBooking.teeInfo}}</p>
          <p><strong>Slot Date:</strong> {{formatDate(selectedBooking.slot_date)}}</p>
          <p><strong>Slot Time:</strong> {{selectedBooking.booking_time}}</p>
          <p><strong>Participants:</strong> {{getParticipantDisplayText(selectedBooking)}}</p>
          
          <div *ngIf="selectedBooking.hasMultipleSlots" class="mt-3">
            <h6>Multi-Slot Booking:</h6>
            <p>This is part of a {{selectedBooking.totalSlots}}-slot booking (Slot {{selectedBooking.slotNumber}})</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeBookingDetails()">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div class="modal-backdrop fade show" *ngIf="showParticipantModal || showReviewRequestModal || showBookingDetails"></div>
