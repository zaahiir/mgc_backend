<div class="orders-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="container">
      <div class="row">
        <div class="col-12">
          <h1>My Bookings</h1>
          <p>Manage your tee time bookings and join requests</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container">
    <div class="row">
      <div class="col-12">
        <!-- Booking Statistics Dashboard -->
        <div class="stats-dashboard">
          <div class="row">
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
              <div class="stat-card">
                <div class="stat-icon">
                  <fa-icon [icon]="calendarIcon"></fa-icon>
                </div>
                <div class="stat-content">
                  <h3>{{getBookingStatistics().totalBookings}}</h3>
                  <p>Total Bookings</p>
                </div>
              </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
              <div class="stat-card confirmed">
                <div class="stat-icon">
                  <fa-icon [icon]="checkCircleIcon"></fa-icon>
                </div>
                <div class="stat-content">
                  <h3>{{getBookingStatistics().confirmed}}</h3>
                  <p>Confirmed</p>
                </div>
              </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
              <div class="stat-card pending">
                <div class="stat-icon">
                  <fa-icon [icon]="exclamationTriangleIcon"></fa-icon>
                </div>
                <div class="stat-content">
                  <h3>{{getBookingStatistics().pendingRequests}}</h3>
                  <p>Pending Requests</p>
                </div>
              </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
              <div class="stat-card approved">
                <div class="stat-icon">
                  <fa-icon [icon]="usersIcon"></fa-icon>
                </div>
                <div class="stat-content">
                  <h3>{{getBookingStatistics().requestsAccepted}}</h3>
                  <p>Requests Accepted</p>
                </div>
              </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
              <div class="stat-card actions">
                <div class="stat-icon">
                  <fa-icon [icon]="infoIcon"></fa-icon>
                </div>
                <div class="stat-content">
                  <h3>{{getBookingStatistics().acceptRejectActions}}</h3>
                  <p>Accept/Reject Actions</p>
                </div>
              </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
              <div class="stat-card cancelled">
                <div class="stat-icon">
                  <fa-icon [icon]="timesIcon"></fa-icon>
                </div>
                <div class="stat-content">
                  <h3>{{getBookingStatistics().cancelled}}</h3>
                  <p>Cancelled</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Filter Controls -->
        <div class="filter-controls">
          <div class="row">
            <div class="col-md-6">
              <div class="filter-group">
                <label for="statusFilter">Filter by Status:</label>
                <select 
                  id="statusFilter" 
                  class="form-control" 
                  [(ngModel)]="selectedStatusFilter"
                  (change)="onStatusFilterChange($event.target.value)">
                  <option *ngFor="let filter of statusFilters" 
                          [value]="filter.value">
                    {{filter.label}} ({{filter.count}})
                  </option>
                </select>
              </div>
            </div>
            <div class="col-md-6 text-md-end">
              <button class="btn btn-outline-primary" (click)="refreshData()">
                <fa-icon [icon]="spinnerIcon" *ngIf="isLoading"></fa-icon>
                Refresh
              </button>
            </div>
          </div>
        </div>

        <!-- Bookings Table -->
        <div class="bookings-table-container">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Booking ID</th>
                  <th>Booked Date</th>
                  <th>Course Name</th>
                  <th>Tee</th>
                  <th>Slot Date</th>
                  <th>Slot Time</th>
                  <th>Participants</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let booking of getFilteredBookings()" 
                    [class.highlighted]="selectedBooking?.id === booking.id">
                  <td>
                    <span class="booking-id">{{booking.booking_id}}</span>
                    <span *ngIf="booking.hasMultipleSlots" class="multi-slot-badge">
                      Multi-slot
                    </span>
                  </td>
                  <td>{{booking.formattedDate}}</td>
                  <td>{{booking.courseName}}</td>
                  <td>
                    <span class="tee-info">{{booking.teeInfo || 'Tee not specified'}}</span>
                    <span *ngIf="booking.hasMultipleSlots" class="slot-number">
                      Slot {{booking.slotNumber}}
                    </span>
                  </td>
                  <td>{{formatDate(booking.slot_date || booking.slotDate || booking.bookingDate)}}</td>
                  <td>{{booking.booking_time || 'N/A'}}</td>
                  <td>
                    <span class="participants">
                      {{booking.participants}} player{{booking.participants > 1 ? 's' : ''}}
                    </span>
                    <span *ngIf="booking.availableSpots && booking.availableSpots > 0" 
                          class="available-spots">
                      ({{booking.availableSpots}} spots left)
                    </span>
                  </td>
                  <td>
                    <span class="status-badge" [class]="getStatusClass(booking.status)">
                      {{getStatusText(booking.status)}}
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm action-btn" 
                            [class]="getActionText(booking) === 'Add Participants' ? 'btn-success' : 'btn-primary'"
                            (click)="handleActionClick(booking)">
                      <fa-icon [icon]="getActionIcon(booking)"></fa-icon>
                      {{getActionText(booking)}}
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- No Bookings Message -->
          <div *ngIf="getFilteredBookings().length === 0 && !isLoading" class="no-bookings">
            <div class="text-center py-5">
              <fa-icon [icon]="infoIcon" class="no-bookings-icon"></fa-icon>
              <h4>No Bookings Found</h4>
              <p *ngIf="selectedStatusFilter === 'all'">
                You haven't made any bookings yet. 
                <a routerLink="/tee-booking">Book your first tee time</a>
              </p>
              <p *ngIf="selectedStatusFilter !== 'all'">
                No {{getStatusText(selectedStatusFilter).toLowerCase()}} bookings found.
              </p>
            </div>
          </div>

          <!-- Loading State -->
          <div *ngIf="isLoading" class="loading-state">
            <div class="text-center py-5">
              <fa-icon [icon]="spinnerIcon" class="spinner"></fa-icon>
              <p>Loading bookings...</p>
            </div>
          </div>

          <!-- Error State -->
          <div *ngIf="errorMessage" class="error-state">
            <div class="alert alert-danger">
              <fa-icon [icon]="exclamationTriangleIcon"></fa-icon>
              {{errorMessage}}
              <button class="btn btn-sm btn-outline-danger ms-2" (click)="refreshData()">
                Retry
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Booking Details Modal -->
<div class="modal-overlay" *ngIf="showBookingDetails" (click)="closeBookingDetails()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Booking Details</h3>
      <button class="modal-close" (click)="closeBookingDetails()">
        <fa-icon [icon]="timesIcon"></fa-icon>
      </button>
    </div>
    
    <div class="modal-body" *ngIf="selectedBooking">
      <div class="booking-details">
        <div class="detail-row">
          <span class="label">Booking ID:</span>
          <span class="value">{{selectedBooking.booking_id}}</span>
        </div>
        <div class="detail-row">
          <span class="label">Course:</span>
          <span class="value">{{selectedBooking.courseName}}</span>
        </div>
        <div class="detail-row">
          <span class="label">Tee:</span>
          <span class="value">{{selectedBooking.teeInfo}}</span>
        </div>
        <div class="detail-row">
          <span class="label">Date:</span>
          <span class="value">{{selectedBooking.formattedDate}}</span>
        </div>
        <div class="detail-row">
          <span class="label">Time:</span>
          <span class="value">{{selectedBooking.booking_time || 'N/A'}}</span>
        </div>
        <div class="detail-row">
          <span class="label">Participants:</span>
          <span class="value">{{selectedBooking.participants}} player{{selectedBooking.participants > 1 ? 's' : ''}}</span>
        </div>
        <div class="detail-row">
          <span class="label">Status:</span>
          <span class="value status-badge" [class]="getStatusClass(selectedBooking.status)">
            {{getStatusText(selectedBooking.status)}}
          </span>
        </div>
        
        <!-- Multi-slot information -->
        <div *ngIf="selectedBooking.hasMultipleSlots" class="multi-slot-info">
          <h5>Multi-Slot Booking</h5>
          <p>This booking contains {{selectedBooking.totalSlots}} slots</p>
          <div *ngIf="selectedBooking.slots" class="slots-list">
            <div *ngFor="let slot of selectedBooking.slots" class="slot-item">
              <span class="slot-time">{{slot.booking_time}}</span>
              <span class="slot-participants">{{slot.participants}}p</span>
              <span class="slot-status" [class]="getStatusClass(slot.slot_status)">
                {{getStatusText(slot.slot_status)}}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeBookingDetails()">Close</button>
    </div>
  </div>
</div>

<!-- Add Participants Modal -->
<div class="modal-overlay" *ngIf="showParticipantModal" (click)="closeParticipantModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Add Participants</h3>
      <button class="modal-close" (click)="closeParticipantModal()">
        <fa-icon [icon]="timesIcon"></fa-icon>
      </button>
    </div>
    
    <div class="modal-body" *ngIf="selectedBookingForParticipants">
      <div class="participant-form">
        <div class="form-group">
          <label>Current Participants: {{selectedBookingForParticipants.participants}}</label>
          <label>Available Spots: {{selectedBookingForParticipants.availableSpots || 0}}</label>
        </div>
        
        <div class="participant-selector">
          <label>Add Participants:</label>
          <div class="selector-controls">
            <button class="btn btn-outline-secondary" 
                    (click)="decrementParticipants()" 
                    [disabled]="requestedParticipants === 1">
              -
            </button>
            <span class="participant-count">{{requestedParticipants}}</span>
            <button class="btn btn-outline-secondary" 
                    (click)="incrementParticipants()" 
                    [disabled]="requestedParticipants >= (selectedBookingForParticipants.availableSpots || 4)">
              +
            </button>
          </div>
          <small class="form-text text-muted">
            Maximum: {{Math.min(selectedBookingForParticipants.availableSpots || 4, 4)}} participants
          </small>
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeParticipantModal()">Cancel</button>
      <button class="btn btn-primary" (click)="confirmAddParticipants()">
        Add Participants
      </button>
    </div>
  </div>
</div>
