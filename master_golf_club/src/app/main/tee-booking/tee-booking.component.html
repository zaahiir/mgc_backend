<section class="page-title d-flex justify-content-center align-items-center">
  <div class="bg-layer" [style.background-image]="'url(' + course.imageUrl + ')'"></div>
  <div class="container">
    <div class="row">
      <div class="col-12">
        <h1>{{course.name}}</h1>
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item">
              <fa-icon [icon]="locationIcon"></fa-icon>
              {{course.lane}}, {{course.address}}
            </li>
          </ol>
        </nav>
      </div>
    </div>
  </div>
</section>

<!-- Main Content Section -->
<section class="course-section">
  <div class="container">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-lg-4 col-md-12 order-lg-1 order-2">
        <!-- Booking Form Widget -->
        <div class="sidebar-widget">
          <div class="widget-title">
            <h3>Book Your Tee Time</h3>
          </div>

          <div class="booking-form">
            <!-- Step 1: Tee Selection -->
            <div class="form-section">
              <div class="label-with-icon">
                <div class="label-group">
                  <fa-icon [icon]="golfIcon" class="section-icon"></fa-icon>
                  <label>Select Tee</label>
                </div>
              </div>
              
              <div class="tee-options">
                <button class="tee-option" 
                        *ngFor="let tee of availableTees"
                        [class.selected]="selectedTee?.id === tee.id"
                        (click)="selectTee(tee)">
                  <span class="tee-name">{{tee.label || (tee.holeNumber + ' Holes')}}</span>
                </button>
                
                <!-- Show message when no tees available -->
                <div *ngIf="availableTees.length === 0 && !isLoading" class="no-tees-message">
                  <p>No tees available for this course.</p>
                  <button class="theme-btn" (click)="loadAvailableTees()">Retry Loading Tees</button>
                </div>
                
                <!-- Show loading state -->
                <div *ngIf="isLoading" class="loading-message">
                  <p>Loading available tees...</p>
                </div>
              </div>
              
              <!-- Debug buttons (remove in production) -->
              <div class="debug-buttons" style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 5px;">
                <button class="btn btn-sm btn-secondary" (click)="debugSessionStorage()" style="margin-right: 5px;">Debug Storage</button>
                <button class="btn btn-sm btn-warning" (click)="clearAllSelectionsManually()" style="margin-right: 5px;">Clear All</button>
                <button class="btn btn-sm btn-info" (click)="debugComponentState()" style="margin-right: 5px;">Debug State</button>
                <button class="btn btn-sm btn-success" (click)="validateSessionStorage()" style="margin-right: 5px;">Validate</button>
                <button class="btn btn-sm btn-outline-warning" (click)="debugSlotVisualState()" style="margin-right: 5px;">Visual State</button>
                <button class="btn btn-sm btn-outline-info" (click)="debugForceSlotUpdate()" style="margin-right: 5px;">Force Update</button>
                <button class="btn btn-sm btn-outline-success" (click)="debugSelectSpecificSlot('06:00')" style="margin-right: 5px;">Select 06:00</button>
                <button class="btn btn-sm btn-outline-danger" (click)="debugCSSClasses()" style="margin-right: 5px;">CSS Debug</button>
                <button class="btn btn-sm btn-outline-primary" (click)="debugCreateTestSelection()" style="margin-right: 5px;">Create Test</button>
                <button class="btn btn-sm btn-outline-dark" (click)="debugTimezoneInfo()" style="margin-right: 5px;">Timezone Debug</button>
                <button class="btn btn-sm btn-outline-warning" (click)="debugSlotSelectionAcrossDates()" style="margin-right: 5px;">Slot Selection Debug</button>
        <button class="btn btn-sm btn-outline-info" (click)="debugDateKeyGeneration()" style="margin-right: 5px;">Date Key Debug</button>
              </div>
            </div>

            <!-- Step 2: Date Selection (only visible after tee selected) -->
            <div class="form-section" *ngIf="selectedTee">
              <div class="label-with-icon">
                <div class="label-group">
                  <fa-icon [icon]="calendarIcon" class="section-icon"></fa-icon>
                  <label>Select Date</label>
                </div>
              </div>

              <!-- Current Date Display -->
              <div class="current-date-display" (click)="toggleCalendar()">
                <div class="date-info">
                  <span class="date-value">{{selectedDate | date:'MMM d, yyyy'}}</span>
                  <span class="date-day">{{selectedDate | date:'EEEE'}}</span>
                  <small class="timezone-info" style="font-size: 0.8em; color: #666; display: block; margin-top: 2px;">
                    Using UK timezone (Europe/London)
                  </small>
                </div>
                <div class="calendar-toggle-icon">
                  <fa-icon [icon]="showCalendar ? chevronUpIcon : chevronDownIcon"></fa-icon>
                </div>
              </div>

              <!-- Calendar View (Collapsible) -->
              <div class="calendar-view" [class.show]="showCalendar">
                <div class="calendar-header">
                  <button class="month-nav" (click)="previousMonth()">
                    <fa-icon [icon]="chevronLeftIcon"></fa-icon>
                  </button>
                  <span class="current-month">{{currentDate | date:'MMMM yyyy'}}</span>
                  <button class="month-nav" (click)="nextMonth()">
                    <fa-icon [icon]="chevronRightIcon"></fa-icon>
                  </button>
                </div>
                <div class="calendar-weekdays">
                  <span *ngFor="let day of weekDays">{{day}}</span>
                </div>
                <div class="calendar-days">
                  <button *ngFor="let day of calendarDays"
                          class="calendar-day"
                          [class.selected]="isDateSelected(day.date)"
                          [class.today]="isToday(day.date)"
                          [class.available]="day.available"
                          [class.other-month]="day.otherMonth"
                          [disabled]="!day.available || day.otherMonth"
                          (click)="selectDate(day.date)">
                    <div class="day-number">{{day.date | date:'d'}}</div>
                  </button>
                </div>
              </div>
            </div>

            <!-- Step 3: Time Selection (only visible after date selected) -->
            <div class="form-section" *ngIf="selectedDate && selectedTee">
              <div class="label-with-icon">
                <div class="label-group">
                  <fa-icon [icon]="clockIcon" class="section-icon"></fa-icon>
                  <label>Available Times</label>
                </div>                
              </div>

              <!-- Color Legend for Time Slots -->
              <div class="time-slot-legend" *ngIf="currentTimeSlots.length > 0">
                <div class="legend-items">
                  <div class="legend-item">
                    <div class="legend-color available-color"></div>
                    <span class="legend-text">Available</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color partial-color"></div>
                    <span class="legend-text">Partially Available</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color selected-color"></div>
                    <span class="legend-text">Selected</span>
                  </div>
                </div>
              </div>
              
              <div class="time-slots-container">
                <div class="time-slots-grid">
                                                        <button *ngFor="let slot of currentTimeSlots"
                            class="time-slot"
                            [class]="getSlotClass(slot)"
                            [disabled]="slot.slot_status === 'booked' || !slot.available"
                            (click)="toggleSlotSelection(slot)"
                            (contextmenu)="deselectSlotDirect(slot); $event.preventDefault()"
                            [title]="getSlotTooltip(slot) + (slot.isSelected ? ' (Right-click to deselect)' : '')"
                            [attr.data-debug]="'isSelected:' + slot.isSelected + ', class:' + getSlotClass(slot)">
                    <div class="time-slot-content">
                      <span class="time">{{slot.time}}</span>
                      <div class="golf-ball" [class.available]="slot.slot_status === 'available'">
                        <div class="dimples">
                          <div class="dimple"></div>
                          <div class="dimple"></div>
                          <div class="dimple"></div>
                        </div>
                      </div>
                    </div>
                  </button>
                </div>
                
                <!-- Show message when no time slots are available -->
                <div *ngIf="currentTimeSlots.length === 0 && !isLoading" class="no-slots-message">
                  <p>No available time slots for the selected date.</p>
                </div>
              </div>
            </div>

            <!-- Booking Summary (only visible when slots are selected) -->
            <div class="booking-summary" *ngIf="canBook()">
              <div class="summary-header">
                <h4>Booking Summary</h4>
              </div>
              
              <!-- Multi-Slot Booking Summary -->
              <div class="summary-details" *ngIf="selectedSlots.length > 0">
                <div class="summary-item">
                  <span class="label">Total Slots:</span>
                  <span class="value">{{selectedSlots.length}} slot{{selectedSlots.length > 1 ? 's' : ''}}</span>
                </div>
                <div class="summary-actions">
                  <button class="clear-all-btn" (click)="clearAllSelections()" title="Clear all selected slots">
                    Clear All
                  </button>
                </div>
              </div>
              
              <!-- Detailed Slot Information - Grouped by Tee -->
              <div class="selected-slots-details" *ngIf="selectedSlots.length > 0">
                <div class="slots-details-header">
                  <h5>Slot Details</h5>
                </div>
                
                <!-- Group slots by tee -->
                <div *ngFor="let teeGroup of getSlotsGroupedByTee(); let teeIndex = index" class="tee-group">
                  <div class="tee-group-header">
                    <h6>{{teeGroup.teeLabel}}</h6>
                    <span class="tee-slot-count">{{teeGroup.slots.length}} slot{{teeGroup.slots.length > 1 ? 's' : ''}}</span>
                  </div>
                  
                  <!-- Slots for this tee -->
                  <div class="slot-detail-item" *ngFor="let slot of teeGroup.slots; let i = index" 
                       (click)="openSlotModal(slot)" 
                       style="cursor: pointer;">
                    <div class="slot-detail-header">
                      <span class="slot-number">Slot {{i + 1}}</span>
                                             <button class="clear-slot-btn" (click)="deselectSlotFromSummary(slot); $event.stopPropagation()" title="Remove this slot">
                         ×
                       </button>
                    </div>
                    <div class="slot-detail-content">
                      <div class="slot-detail-row">
                        <span class="label">Date:</span>
                        <span class="value">{{slot.date | date:'EEEE, MMMM d, yyyy'}}</span>
                      </div>
                      <div class="slot-detail-row">
                        <span class="label">Time:</span>
                        <span class="value">{{slot.time}}</span>
                      </div>
                      <div class="slot-detail-row">
                        <span class="label">Participants:</span>
                        <span class="value">{{slot.participants}} player{{slot.participants > 1 ? 's' : ''}}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <button class="theme-btn w-100"
                    [disabled]="!canBook()"
                    [class.loading]="isLoading"
                    (click)="bookTeeTime()">
              {{isLoading ? 'Booking...' : 
                (selectedSlots.length > 0 ? 
                  ('Book ' + selectedSlots.length + ' Slot' + (selectedSlots.length > 1 ? 's' : '')) : 
                  'Book Now'
                )
              }}
            </button>
            
            <!-- Login prompt for unauthenticated users -->
            <div class="login-prompt" *ngIf="!isAuthenticated()">
              <p><small>Please log in to book a tee time</small></p>
            </div>



            <div class="error-message" *ngIf="errorMessage">
              {{errorMessage}}
            </div>
          </div>
        </div>
        
        <!-- Optimized Contact & Directions Widget -->
        <div class="contact-directions-widget">
          <div class="widget-header">
            <h3><fa-icon [icon]="locationIcon"></fa-icon> Contact & Directions</h3>
          </div>
          
          <div class="contact-info">
            <div class="info-item" (click)="copyToClipboard(course.address)">
              <div class="icon-wrapper">
                <fa-icon [icon]="locationIcon"></fa-icon>
              </div>
              <div class="info-content">
                <span class="label">Location</span>
                <span class="value">{{course.address}}</span>
              </div>
              <div class="action-icon">
                <fa-icon [icon]="copyIcon" title="Copy address"></fa-icon>
              </div>
            </div>

            <div class="info-item" (click)="makeCall()">
              <div class="icon-wrapper">
                <fa-icon [icon]="phoneIcon"></fa-icon>
              </div>
              <div class="info-content">
                <span class="label">Phone</span>
                <span class="value">{{course.phone}}</span>
              </div>
              <div class="action-icon">
                <fa-icon [icon]="phoneIcon" title="Call now"></fa-icon>
              </div>
            </div>
          </div>

          <div class="direction-actions">
            <button class="action-btn primary" (click)="getDirections()">
              <fa-icon [icon]="directionsIcon"></fa-icon>
              <span>Get Directions</span>
            </button>
            <button class="action-btn secondary" (click)="shareLocation()">
              <fa-icon [icon]="shareIcon"></fa-icon>
              <span>Share Location</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="col-lg-8 col-md-12 order-lg-2 order-1">
        <div class="main-content">
          <!-- Course Image -->
          <img [src]="course.imageUrl"
               alt="{{course.name}}"
               class="hero-image">

          <!-- Course Information -->
          <div class="content-section">
            <h2>About {{course.name}}</h2>
            <p *ngIf="course.description">{{course.description}}</p>
            <p *ngIf="!course.description">Experience exceptional golfing conditions with our meticulously maintained fairways, challenging layout, and stunning natural surroundings. Perfect for golfers of all skill levels.</p>

            <h3>Our facilities include</h3>
            <div class="amenities-grid" *ngIf="course.amenities && course.amenities.length > 0">
              <div class="amenity-item" *ngFor="let amenity of course.amenities; trackBy: trackByAmenity">
                <div class="amenity-icon-wrapper">
                  <div class="amenity-icon" *ngIf="getSafeSvgIcon(amenity)" [innerHTML]="getSafeSvgIcon(amenity)"></div>
                  <fa-icon *ngIf="!getSafeSvgIcon(amenity)" [icon]="getAmenityIcon(amenity)"></fa-icon>
                </div>
                <div class="amenity-content">
                  <h4 class="amenity-name">{{amenity.amenityName}}</h4>
                  <p class="amenity-description">{{amenity.amenitiesDescription || amenity.amenityTooltip}}</p>
                </div>
              </div>
            </div>
            
            <!-- Fallback facilities if no amenities are available -->
            <div class="amenities-grid" *ngIf="!course.amenities || course.amenities.length === 0">
              <div class="amenity-item">
                <div class="amenity-icon-wrapper">
                  <fa-icon [icon]="wifiIcon"></fa-icon>
                </div>
                <div class="amenity-content">
                  <h4 class="amenity-name">Free WiFi</h4>
                  <p class="amenity-description">Stay connected throughout your visit with complimentary high-speed internet access.</p>
                </div>
              </div>
              <div class="amenity-item">
                <div class="amenity-icon-wrapper">
                  <fa-icon [icon]="parkingIcon"></fa-icon>
                </div>
                <div class="amenity-content">
                  <h4 class="amenity-name">Free Parking</h4>
                  <p class="amenity-description">Convenient and secure parking facilities available for all guests.</p>
                </div>
              </div>
              <div class="amenity-item">
                <div class="amenity-icon-wrapper">
                  <fa-icon [icon]="restaurantIcon"></fa-icon>
                </div>
                <div class="amenity-content">
                  <h4 class="amenity-name">Restaurant</h4>
                  <p class="amenity-description">Enjoy delicious meals and refreshments at our on-site restaurant.</p>
                </div>
              </div>
              <div class="amenity-item">
                <div class="amenity-icon-wrapper">
                  <fa-icon [icon]="shopIcon"></fa-icon>
                </div>
                <div class="amenity-content">
                  <h4 class="amenity-name">Pro Shop</h4>
                  <p class="amenity-description">Browse our fully-stocked pro shop for all your golfing needs.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Slot Selection Modal (Integrated into booking flow) -->
<div class="slot-modal-overlay" *ngIf="showSlotModal && currentSlotForModal" (click)="closeSlotModal()">
  <div class="slot-modal-content" (click)="$event.stopPropagation()">
    <div class="slot-modal-header">
      <h3 class="slot-modal-title">Slot Details</h3>
      <button class="slot-modal-close" (click)="closeSlotModal()">
        ×
      </button>
    </div>
    
    <div class="slot-modal-body" *ngIf="currentSlotForModal">
      <!-- Loading state -->
      <div *ngIf="!currentSlotForModal.formatted_time && !currentSlotForModal.time" class="loading-message">
        <p>Loading slot details...</p>
      </div>
      
      <!-- Slot content when data is available -->
      <div *ngIf="currentSlotForModal.formatted_time || currentSlotForModal.time">
        <!-- Participant Selector in Modal -->
        <div class="slot-modal-section">
          <div class="slot-modal-section-title">
            <div class="slot-modal-section-icon">
              <fa-icon [icon]="usersIcon"></fa-icon>
            </div>
            Add Participants
          </div>
          <div class="player-selector modal-player-selector">
            <button class="circle-btn" (click)="decrementModalParticipants()" [disabled]="currentSlotParticipants === 1">-</button>
            <span class="player-count">{{currentSlotParticipants}}</span>
            <button class="circle-btn" (click)="incrementModalParticipants()" [disabled]="currentSlotParticipants >= (currentSlotForModal.available_spots || 4)">+</button>
          </div>
                    <div class="slot-info-text small-text">
            (Max: {{getMaxModalParticipants()}} participants)
          </div>
        </div>

        <!-- Slot Information Row -->
        <div class="slot-modal-section">
          <div class="slot-modal-section-title">
            <div class="slot-modal-section-icon">
              <fa-icon [icon]="golfIcon"></fa-icon>
            </div>
            Slot Information
          </div>
          <div class="slot-info-row">
            <div class="slot-info-item">
              <span class="slot-info-label">Course:</span>
              <span class="slot-info-value course-name">{{course.name}}</span>
            </div>
            <div class="slot-info-item">
              <span class="slot-info-label">Tee:</span>
              <span class="slot-info-value tee-name">{{currentSlotForModal.tee_name || selectedTee?.label || (selectedTee?.holeNumber + ' Holes')}}</span>
            </div>
            <div class="slot-info-item">
              <span class="slot-info-label">Date:</span>
              <span class="slot-info-value slot-date">
                {{currentSlotForModal.slot_date ? (currentSlotForModal.slot_date | date:'EEEE, MMMM d, yyyy') : (selectedDate | date:'EEEE, MMMM d, yyyy')}}
              </span>
            </div>
            <div class="slot-info-item">
              <span class="slot-info-label">Time:</span>
              <span class="slot-info-value slot-time">{{currentSlotForModal?.formatted_time || currentSlotForModal?.time || 'N/A'}}</span>
            </div>
            <div class="slot-info-item">
              <span class="slot-info-label">Status:</span>
              <span class="slot-info-value slot-status" 
                    [class.status-selected]="currentSlotForModal?.slot_status === 'selected'"
                    [class.status-available]="currentSlotForModal?.slot_status === 'available'"
                    [class.status-partial]="currentSlotForModal?.slot_status === 'partially_available'"
                    [class.status-booked]="currentSlotForModal?.slot_status === 'booked'">
                {{ 
                  currentSlotForModal?.slot_status === 'selected' ? 'Selected' :
                  (currentSlotForModal?.slot_status === 'available' ? 'Available' : 
                  (currentSlotForModal?.slot_status === 'partially_available' ? 'Partially Available' : 
                  (currentSlotForModal?.slot_status || (currentSlotForModal?.available ? 'Available' : 'Booked')))) 
                }}
              </span>
            </div>
            <div class="slot-info-item">
              <span class="slot-info-label">Available Spots:</span>
              <span class="slot-info-value available-spots">{{currentSlotForModal?.available_spots || 4}}</span>
            </div>
            <div class="slot-info-item">
              <span class="slot-info-label">Current Participants:</span>
              <span class="slot-info-value current-participants">{{currentSlotForModal.total_participants}}/4</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Debug Information (remove in production) -->
      <div class="slot-modal-section" style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 15px;">
        <div class="slot-modal-section-title" style="font-size: 12px; color: #666;">
          Debug Info (Raw Data)
        </div>
        <div style="font-size: 11px; color: #888; font-family: monospace;">
          <div>Time: {{currentSlotForModal?.time}} | Formatted: {{currentSlotForModal?.formatted_time}}</div>
          <div>Status: {{currentSlotForModal?.slot_status}} | Available: {{currentSlotForModal?.available}} | IsSelected: {{isSlotAlreadySelected(currentSlotForModal)}}</div>
          <div>Spots: {{currentSlotForModal?.available_spots}} | Participants: {{currentSlotForModal?.total_participants}}</div>
          <div>Date: {{currentSlotForModal?.slot_date}} | Tee: {{currentSlotForModal?.tee_id}} - {{currentSlotForModal?.tee_name}}</div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="slot-modal-actions">
        <button class="slot-modal-btn secondary" (click)="closeSlotModal()">
          Cancel
        </button>
        <button class="slot-modal-btn primary" 
                (click)="confirmSlotSelection()"
                [disabled]="currentSlotParticipants > (currentSlotForModal.available_spots || 4)">
          Select Slot
        </button>
      </div>
      </div>
    </div>
</div>

<!-- Booking Confirmation Modal -->
<div class="modal-overlay" *ngIf="showBookingModal" (click)="closeBookingModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Booking Confirmation</h3>
      <button class="modal-close" (click)="closeBookingModal()">
        <fa-icon [icon]="chevronUpIcon"></fa-icon>
      </button>
    </div>
    
    <div class="modal-body" *ngIf="bookingConfirmationData">
      <div class="confirmation-icon">
        <fa-icon [icon]="golfIcon"></fa-icon>
      </div>
      
      <div class="confirmation-message">
        <h4>Your tee time has been booked successfully!</h4>
        <p *ngIf="bookingConfirmationData.totalSlots" class="total-bookings">{{bookingConfirmationData.totalSlots}} individual booking{{bookingConfirmationData.totalSlots > 1 ? 's' : ''}} created</p>
      </div>
      
      <div class="booking-details">
        <div class="detail-item">
          <span class="label">Course:</span>
          <span class="value">{{bookingConfirmationData.courseName || course.name}}</span>
        </div>
        <div class="detail-item" *ngIf="bookingConfirmationData.selectedSlots">
          <span class="label">Slots:</span>
          <div class="value slots-list">
            <div class="slot-item" *ngFor="let slot of bookingConfirmationData.selectedSlots; let i = index">
              <div class="slot-row">
                <div class="slot-main-info">
                  <span class="slot-tee-info">{{slot.tee_name || slot.tee || 'Unknown Tee'}}: {{slot.time}}</span>
                  <span class="slot-date">{{slot.date ? (slot.date | date:'MMM d, yyyy') : 'N/A'}}</span>
                  <span class="slot-participants">{{slot.participants}}p</span>
                </div>
                <!-- Show individual booking ID for each slot -->
                <div class="slot-booking-id" *ngIf="bookingConfirmationData.slotBookings && bookingConfirmationData.slotBookings[i]">
                  <strong>ID: {{bookingConfirmationData.slotBookings[i].booking_id}}</strong>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="detail-item">
          <span class="label">Status:</span>
          <span class="value status-pending">{{bookingConfirmationData.status || 'Pending'}}</span>
        </div>
      </div>
      
      <div class="confirmation-actions">
        <button class="theme-btn" (click)="closeBookingModal()">
          <fa-icon [icon]="golfIcon"></fa-icon>
          Continue Booking
        </button>
      </div>
    </div>
  </div>
</div>