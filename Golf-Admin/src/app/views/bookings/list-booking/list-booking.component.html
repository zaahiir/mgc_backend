<!-- Loading Spinner -->
<div *ngIf="isLoading" class="d-flex justify-content-center align-items-center" style="min-height: 400px;">
  <c-spinner color="primary" size="sm"></c-spinner>
</div>

<!-- Main Content -->
<div *ngIf="!isLoading">
  <!-- Statistics Cards -->
  <c-row class="mb-4">
    <c-col xs="12" sm="6" lg="3" class="mb-3">
      <c-card class="text-center h-100 stats-card">
        <c-card-body class="d-flex flex-column justify-content-center">
          <div class="stats-icon mb-2">
            <svg [cIcon]="icons.cilCalendar" size="2xl" class="text-primary"></svg>
          </div>
          <h3 class="mb-1 fw-bold">{{ statistics.totalBookings }}</h3>
          <p class="text-muted mb-0 small">TOTAL BOOKINGS</p>
        </c-card-body>
      </c-card>
    </c-col>
    
    <c-col xs="12" sm="6" lg="3" class="mb-3">
      <c-card class="text-center h-100 stats-card">
        <c-card-body class="d-flex flex-column justify-content-center">
          <div class="stats-icon mb-2">
            <svg [cIcon]="icons.cilCheckCircle" size="2xl" class="text-success"></svg>
          </div>
          <h3 class="mb-1 fw-bold">{{ statistics.confirmedBookings }}</h3>
          <p class="text-muted mb-0 small">CONFIRMED BOOKINGS</p>
        </c-card-body>
      </c-card>
    </c-col>
    
    <c-col xs="12" sm="6" lg="3" class="mb-3">
      <c-card class="text-center h-100 stats-card">
        <c-card-body class="d-flex flex-column justify-content-center">
          <div class="stats-icon mb-2">
            <svg [cIcon]="icons.cilClock" size="2xl" class="text-warning"></svg>
          </div>
          <h3 class="mb-1 fw-bold">{{ statistics.pendingRequests }}</h3>
          <p class="text-muted mb-0 small">PENDING REQUESTS</p>
        </c-card-body>
      </c-card>
    </c-col>
    
    <c-col xs="12" sm="6" lg="3" class="mb-3">
      <c-card class="text-center h-100 stats-card">
        <c-card-body class="d-flex flex-column justify-content-center">
          <div class="stats-icon mb-2">
            <svg [cIcon]="icons.cilUser" size="2xl" class="text-info"></svg>
          </div>
          <h3 class="mb-1 fw-bold">{{ statistics.approvedRequests }}</h3>
          <p class="text-muted mb-0 small">APPROVED REQUESTS</p>
        </c-card-body>
      </c-card>
    </c-col>
    
    <c-col xs="12" sm="6" lg="3" class="mb-3">
      <c-card class="text-center h-100 stats-card">
        <c-card-body class="d-flex flex-column justify-content-center">
          <div class="stats-icon mb-2">
            <svg [cIcon]="icons.cilXCircle" size="2xl" class="text-danger"></svg>
          </div>
          <h3 class="mb-1 fw-bold">{{ statistics.rejectedRequests }}</h3>
          <p class="text-muted mb-0 small">REJECTED REQUESTS</p>
        </c-card-body>
      </c-card>
    </c-col>
    
    <c-col xs="12" sm="6" lg="3" class="mb-3">
      <c-card class="text-center h-100 stats-card">
        <c-card-body class="d-flex flex-column justify-content-center">
          <div class="stats-icon mb-2">
            <svg [cIcon]="icons.cilBan" size="2xl" class="text-secondary"></svg>
          </div>
          <h3 class="mb-1 fw-bold">{{ statistics.cancelledBookings }}</h3>
          <p class="text-muted mb-0 small">CANCELLED</p>
        </c-card-body>
      </c-card>
    </c-col>
    
    <c-col xs="12" sm="6" lg="3" class="mb-3">
      <c-card class="text-center h-100 stats-card">
        <c-card-body class="d-flex flex-column justify-content-center">
          <div class="stats-icon mb-2">
            <svg [cIcon]="icons.cilCalendar" size="2xl" class="text-primary"></svg>
          </div>
          <h3 class="mb-1 fw-bold">{{ statistics.todaysBookings }}</h3>
          <p class="text-muted mb-0 small">TODAY'S BOOKINGS</p>
        </c-card-body>
      </c-card>
    </c-col>
    
    <c-col xs="12" sm="6" lg="3" class="mb-3">
      <c-card class="text-center h-100 stats-card">
        <c-card-body class="d-flex flex-column justify-content-center">
          <div class="stats-icon mb-2">
            <svg [cIcon]="icons.cilBuilding" size="2xl" class="text-success"></svg>
          </div>
          <h3 class="mb-1 fw-bold">{{ statistics.activeCourses }}</h3>
          <p class="text-muted mb-0 small">ACTIVE COURSES</p>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>

  <!-- Filter and Search Section -->
  <c-card class="mb-4">
    <c-card-body>
      <!-- Primary Filter Row -->
      <c-row class="mb-3">
        <c-col xs="12" md="6">
          <div class="d-flex flex-wrap gap-2 align-items-center">
            <!-- View Toggle Buttons -->
            <c-button-group role="group">
              <button 
                cButton 
                [color]="currentView === 'all' ? 'primary' : 'outline-primary'"
                (click)="switchView('all')"
                size="sm">
                All Records ({{ statistics.totalBookings }})
              </button>
              <button 
                cButton 
                [color]="currentView === 'bookings' ? 'success' : 'outline-success'"
                (click)="switchView('bookings')"
                size="sm">
                Bookings ({{ statistics.confirmedBookings }})
              </button>
              <button 
                cButton 
                [color]="currentView === 'requests' ? 'warning' : 'outline-warning'"
                (click)="switchView('requests')"
                size="sm">
                Requests ({{ statistics.pendingRequests + statistics.approvedRequests + statistics.rejectedRequests }})
              </button>
            </c-button-group>
          </div>
        </c-col>
        
        <c-col xs="12" md="6">
          <div class="d-flex flex-wrap gap-2 justify-content-md-end">
            <button 
              cButton 
              color="outline-secondary" 
              size="sm"
              (click)="refreshData()"
              [disabled]="isLoading">
              <svg [cIcon]="icons.cilRefresh" class="me-1"></svg>
              Refresh
            </button>
            <button 
              cButton 
              color="outline-info" 
              size="sm"
              (click)="toggleAdvancedFilters()">
              <svg [cIcon]="icons.cilFilter" class="me-1"></svg>
              Filters
            </button>
            <button 
              cButton 
              color="outline-success" 
              size="sm"
              (click)="exportData('csv')"
              [disabled]="isExporting">
              <svg [cIcon]="icons.cilDownload" class="me-1"></svg>
              Export CSV
            </button>
          </div>
        </c-col>
      </c-row>

      <!-- Search Bar -->
      <c-row class="mb-3">
        <c-col xs="12" md="6">
          <div class="position-relative">
            <input 
              cFormControl 
              type="search" 
              placeholder="Search by Booking ID, Member Name, Course..."
              [(ngModel)]="searchTerm"
              (input)="onSearch($event)"
              class="ps-5">
            <svg [cIcon]="icons.cilSearch" class="position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></svg>
          </div>
        </c-col>
      </c-row>

      <!-- Advanced Filters -->
      <div *ngIf="showAdvancedFilters" class="border-top pt-3">
        <form [formGroup]="filterForm" cForm>
          <c-row class="g-3">
            <c-col xs="12" sm="6" md="3">
              <label cFormLabel>Status</label>
              <select cFormSelect formControlName="status">
                <option *ngFor="let option of statusOptions" [value]="option.value">
                  {{ option.label }} ({{ option.count }})
                </option>
              </select>
            </c-col>
            
            <c-col xs="12" sm="6" md="3">
              <label cFormLabel>Course</label>
              <select cFormSelect formControlName="course" (change)="onCourseChange($event)">
                <option value="">All Courses</option>
                <option *ngFor="let course of courses" [value]="course.id">
                  {{ course.name }}
                </option>
              </select>
            </c-col>
            
            <c-col xs="12" sm="6" md="3">
              <label cFormLabel>Tee</label>
              <select cFormSelect formControlName="tee">
                <option value="">All Tees</option>
                <option *ngFor="let tee of tees" [value]="tee.id">
                  {{ tee.holeNumber }} Holes
                </option>
              </select>
            </c-col>
            
            <c-col xs="12" sm="6" md="3">
              <label cFormLabel>Date From</label>
              <input cFormControl type="date" formControlName="dateFrom">
            </c-col>
            
            <c-col xs="12" sm="6" md="3">
              <label cFormLabel>Date To</label>
              <input cFormControl type="date" formControlName="dateTo">
            </c-col>
            
            <c-col xs="12" sm="6" md="3">
              <label cFormLabel>Participants</label>
              <select cFormSelect formControlName="participants">
                <option *ngFor="let option of participantOptions" [value]="option.value">
                  {{ option.label }}
                </option>
              </select>
            </c-col>
            
            <c-col xs="12" sm="6" md="3">
              <label cFormLabel>Booking ID</label>
              <input cFormControl type="text" placeholder="Search by ID" formControlName="bookingId">
            </c-col>
            
            <c-col xs="12" md="6" class="d-flex align-items-end">
              <button 
                cButton 
                color="outline-secondary" 
                size="sm"
                type="button"
                (click)="clearAllFilters()">
                Clear All Filters
              </button>
            </c-col>
          </c-row>
        </form>
      </div>
    </c-card-body>
  </c-card>

  <!-- Bookings Table -->
  <c-card>
    <c-card-body>
      <!-- Table Controls -->
      <c-row class="mb-3">
        <c-col xs="12" sm="6">
          <p class="mb-0 text-muted">
            Showing {{ (currentPage - 1) * itemsPerPage + 1 }}-{{ Math.min(currentPage * itemsPerPage, totalItems) }} 
            of {{ totalItems }} records
          </p>
        </c-col>
        <c-col xs="12" sm="6" class="text-sm-end">
          <div class="d-flex align-items-center justify-content-sm-end gap-2">
            <label class="mb-0 text-muted small">Show:</label>
            <select cFormSelect size="sm" style="width: auto;" (change)="changeItemsPerPage($event)">
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
            <span class="text-muted small">records per page</span>
          </div>
        </c-col>
      </c-row>

      <!-- Responsive Table -->
      <div class="table-responsive">
        <table cTable [hover]="true" [striped]="true" [bordered]="true">
          <thead>
            <tr>
              <th scope="col" style="width: 50px;">
                <c-form-check>
                  <input 
                    cFormCheckInput 
                    type="checkbox" 
                    [checked]="selectAll"
                    (change)="toggleSelectAll()">
                </c-form-check>
              </th>
              <th scope="col">BOOKING ID</th>
              <th scope="col">TYPE</th>
              <th scope="col">MEMBER</th>
              <th scope="col">BOOKED DATE</th>
              <th scope="col">COURSE</th>
              <th scope="col">TEE</th>
              <th scope="col">SLOT DATE</th>
              <th scope="col">SLOT TIME</th>
              <th scope="col">PARTICIPANTS</th>
              <th scope="col">STATUS</th>
              <th scope="col" style="width: 100px;">DETAILS</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let booking of paginatedBookings; let i = index">
              <td>
                <c-form-check>
                  <input 
                    cFormCheckInput 
                    type="checkbox" 
                    [checked]="isSelected(booking.id)"
                    (change)="toggleSelectBooking(booking.id)">
                </c-form-check>
              </td>
              <td>
                <code class="booking-id" [cTooltip]="'Click to copy'" (click)="copyToClipboard(booking.booking_id)">
                  {{ booking.booking_id }}
                </code>
              </td>
              <td>
                <c-badge 
                  [color]="booking.type === 'BOOKING' ? 'primary' : 'info'"
                  class="d-flex align-items-center gap-1">
                  <svg [cIcon]="getTypeIcon(booking.type)" size="sm"></svg>
                  {{ booking.type }}
                </c-badge>
              </td>
              <td>
                <div>
                  <div class="fw-semibold">{{ booking.member.name }}</div>
                  <small class="text-muted">{{ booking.member.id }}</small>
                </div>
              </td>
              <td>{{ booking.bookedDate }}</td>
              <td>{{ booking.course.name }}</td>
              <td>{{ booking.tee.name }}</td>
              <td>{{ booking.slotDate }}</td>
              <td>{{ booking.slotTime }}</td>
              <td>
                <span class="fw-semibold">{{ formatParticipants(booking) }}</span>
              </td>
              <td>
                <c-badge 
                  [color]="getStatusBadgeColor(booking.status)"
                  class="d-flex align-items-center gap-1">
                  <svg [cIcon]="getStatusIcon(booking.status)" size="sm"></svg>
                  {{ booking.status }}
                </c-badge>
              </td>
              <td>
                <button 
                  cButton 
                  color="outline-primary" 
                  size="sm"
                  (click)="viewDetails(booking)"
                  [cTooltip]="'View Details'">
                  <svg [cIcon]="icons.cilEye"></svg>
                </button>
              </td>
            </tr>
            
            <!-- Empty State -->
            <tr *ngIf="paginatedBookings.length === 0">
              <td colspan="12" class="text-center py-5">
                <div class="text-muted">
                  <svg [cIcon]="icons.cilCalendar" size="3xl" class="mb-3 opacity-50"></svg>
                  <h5>No bookings found</h5>
                  <p>Try adjusting your search criteria or filters.</p>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <c-row class="mt-3" *ngIf="totalPages > 1">
        <c-col xs="12">
          <c-pagination class="justify-content-center">
            <c-page-item [disabled]="currentPage === 1">
              <a cPageLink (click)="changePage(1)" [attr.aria-disabled]="currentPage === 1">First</a>
            </c-page-item>
            <c-page-item [disabled]="currentPage === 1">
              <a cPageLink (click)="changePage(currentPage - 1)" [attr.aria-disabled]="currentPage === 1">Previous</a>
            </c-page-item>
            
            <c-page-item *ngFor="let page of pageRange" [active]="currentPage === page">
              <a cPageLink (click)="changePage(page)">{{ page }}</a>
            </c-page-item>
            
            <c-page-item [disabled]="currentPage === totalPages">
              <a cPageLink (click)="changePage(currentPage + 1)" [attr.aria-disabled]="currentPage === totalPages">Next</a>
            </c-page-item>
            <c-page-item [disabled]="currentPage === totalPages">
              <a cPageLink (click)="changePage(totalPages)" [attr.aria-disabled]="currentPage === totalPages">Last</a>
            </c-page-item>
          </c-pagination>
        </c-col>
      </c-row>
    </c-card-body>
  </c-card>
</div>

<!-- Details Modal -->
<c-modal 
  [visible]="showDetailsModal" 
  (visibleChange)="showDetailsModal = $event"
  size="lg"
  scrollable="true">
  <c-modal-header>
    <h4 cModalTitle>
      {{ selectedBookingDetails?.type === 'REQUEST' ? 'Join Request Details' : 'Booking Details' }}
    </h4>
  </c-modal-header>
  <c-modal-body *ngIf="selectedBookingDetails">
    <div class="booking-details">
      <!-- Basic Information -->
      <div class="row mb-4">
        <div class="col-md-6">
          <h6 class="text-muted mb-2">{{ selectedBookingDetails.type === 'REQUEST' ? 'Request ID' : 'Booking ID' }}</h6>
          <p class="fw-bold">{{ selectedBookingDetails.booking_id }}</p>
        </div>
        <div class="col-md-6">
          <h6 class="text-muted mb-2">Type</h6>
          <c-badge [color]="selectedBookingDetails.type === 'BOOKING' ? 'primary' : 'info'">
            {{ selectedBookingDetails.type === 'REQUEST' ? 'JOIN REQUEST' : 'ORIGINAL BOOKING' }}
          </c-badge>
        </div>
      </div>

      <!-- Member Information -->
      <div class="border-top pt-3 mb-4">
        <h6 class="text-primary mb-3">Member Information</h6>
        <div class="row">
          <div class="col-md-6">
            <p><strong>Name:</strong> {{ selectedBookingDetails.member.name }}</p>
            <p><strong>Membership ID:</strong> {{ selectedBookingDetails.member.id }}</p>
          </div>
          <div class="col-md-6">
            <p><strong>Email:</strong> {{ selectedBookingDetails.member.email || 'N/A' }}</p>
            <p><strong>Phone:</strong> {{ selectedBookingDetails.member.phone || 'N/A' }}</p>
          </div>
        </div>
      </div>

      <!-- Booking Details -->
      <div class="border-top pt-3 mb-4">
        <h6 class="text-primary mb-3">
          {{ selectedBookingDetails.type === 'REQUEST' ? 'Request Details' : 'Booking Details' }}
        </h6>
        <div class="row">
          <div class="col-md-6">
            <p><strong>{{ selectedBookingDetails.type === 'REQUEST' ? 'Requested Date:' : 'Booked Date:' }}</strong> {{ selectedBookingDetails.bookedDate }}</p>
            <p><strong>Course:</strong> {{ selectedBookingDetails.course.name }}</p>
            <p><strong>Tee:</strong> {{ selectedBookingDetails.tee.name }}</p>
          </div>
          <div class="col-md-6">
            <p><strong>Slot Date:</strong> {{ selectedBookingDetails.slotDate }}</p>
            <p><strong>Slot Time:</strong> {{ selectedBookingDetails.slotTime }}</p>
            <p><strong>Participants:</strong> {{ formatParticipants(selectedBookingDetails) }}</p>
          </div>
        </div>
      </div>

      <!-- Status Information -->
      <div class="border-top pt-3">
        <h6 class="text-primary mb-3">Status Information</h6>
        <div class="d-flex align-items-center gap-2 mb-3">
          <c-badge [color]="getStatusBadgeColor(selectedBookingDetails.status)" class="d-flex align-items-center gap-1">
            <svg [cIcon]="getStatusIcon(selectedBookingDetails.status)" size="sm"></svg>
            {{ selectedBookingDetails.status }}
          </c-badge>
        </div>
      </div>
    </div>
  </c-modal-body>
  <c-modal-footer>
    <button cButton color="secondary" (click)="closeDetailsModal()">Close</button>
  </c-modal-footer>
</c-modal>
  